name: Build macOS App

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      # --- Checkout repository ---
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      # --- Set up Python ---
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- Install dependencies ---
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.* pyside6==6.* upx

      # --- Verify binary and config folders before build ---
      - name: ğŸ§© Verify local bin/config presence
        run: |
          echo "ğŸ§© Checking local binaries and configs..."
          ls -lh bin || echo "âŒ bin folder missing!"
          ls -lh config || echo "âŒ config folder missing!"

      # --- Run PyInstaller build ---
      - name: ğŸ—ï¸ Build macOS App (.app + DMG)
        run: |
          echo "ğŸ—ï¸ Building macOS app bundle..."
          python -m PyInstaller build_macos.spec

      # --- Verify inclusion inside .app ---
      - name: ğŸ” Verify .app contents
        run: |
          echo "ğŸ” Verifying inclusion of binaries and config..."
          if [ -d "dist/WebTvMux.app/Contents/MacOS/bin" ]; then
            echo "âœ… bin folder found inside .app:"
            du -sh dist/WebTvMux.app/Contents/MacOS/bin/*
          else
            echo "âŒ bin folder missing inside .app!"
            ls -R dist || true
          fi

          if [ -d "dist/WebTvMux.app/Contents/MacOS/config" ]; then
            echo "âœ… config folder found inside .app:"
            ls -lh dist/WebTvMux.app/Contents/MacOS/config
          else
            echo "âŒ config folder missing inside .app!"
          fi

      # --- Create DMG and ZIP ---
      - name: ğŸ“¦ Package .app into DMG and ZIP
        run: |
          echo "ğŸ“¦ Creating DMG..."
          mkdir -p dist/release
          hdiutil create -volname WebTvMux \
            -srcfolder "dist/WebTvMux.app" \
            -ov -format UDZO "dist/release/WebTvMux.dmg"

          echo "ğŸ“¦ Creating ZIP..."
          cd dist
          zip -r release/WebTvMux.zip WebTvMux.app
          cd ..

          echo "âœ… Packaging complete:"
          du -sh dist/release/*

      # --- Upload artifacts for download ---
      - name: â¬†ï¸ Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WebTvMux-macOS
          path: |
            dist/release/WebTvMux.dmg
            dist/release/WebTvMux.zip
