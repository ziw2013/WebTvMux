name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      - name: 🧰 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ⚙️ Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller==6.* pyside6==6.* packaging

      - name: 🧹 Prepare build environment
        run: |
          echo "🧹 Cleaning up old build folders..."
          rm -rf build dist
          mkdir -p bin config

          echo "🧩 Checking local binaries and configs..."
          ls -lh bin || echo "⚠️ No bin folder found"
          ls -lh config || echo "⚠️ No config folder found"

      - name: 🏗️ Build macOS app with PyInstaller
        run: |
          echo "🚀 Running PyInstaller..."
          python -m PyInstaller build_macos.spec --noconfirm
        env:
          PYTHONWARNINGS: ignore

      - name: 🧩 Verify build outputs
        run: |
          echo "🔍 Verifying inclusion of binaries and config..."
          if [ ! -d "dist/WebTvMux.app" ]; then
            echo "❌ WebTvMux.app not found!"
            exit 1
          fi
          echo "✅ Found WebTvMux.app"
          find dist/WebTvMux.app -type f | grep -E "ffmpeg|ffprobe|yt-dlp|languages.json" || echo "⚠️ Missing some files"

      - name: 🧱 Prepare DMG and compress artifact
        run: |
          echo "📦 Preparing release package..."
          cd dist
          if [ -f "WebTvMux.dmg" ]; then
            echo "✅ Found DMG: $(du -h WebTvMux.dmg)"
          else
            echo "⚠️ DMG not found, creating fallback ZIP..."
            zip -r WebTvMux-macOS.zip WebTvMux.app
          fi
          cd ..

      - name: 🚀 Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WebTvMux-macOS
          path: |
            dist/WebTvMux.dmg
            dist/WebTvMux-macOS.zip
