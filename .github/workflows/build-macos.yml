name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller==6.* pyside6==6.* packaging

      - name: ğŸ§¹ Prepare build environment
        run: |
          echo "ğŸ§¹ Cleaning previous build artifacts..."
          rm -rf build dist
          mkdir -p build/build_macos
          mkdir -p bin config

          echo "ğŸ“ Ensured build path exists: build/build_macos"
          echo "ğŸ§© Checking local binaries and configs..."
          ls -lh bin || echo "âš ï¸ No bin folder found"
          ls -lh config || echo "âš ï¸ No config folder found"

      - name: ğŸ—ï¸ Build macOS app with PyInstaller
        run: |
          echo "ğŸš€ Running PyInstaller..."
          python -m PyInstaller build_macos.spec --noconfirm
        env:
          PYTHONWARNINGS: ignore

      - name: ğŸ” Verify build outputs
        run: |
          echo "ğŸ” Verifying inclusion of binaries and config..."
          if [ ! -d "dist/WebTvMux.app" ]; then
            echo "âŒ WebTvMux.app not found!"
            exit 1
          fi
          echo "âœ… Found WebTvMux.app"
          echo "ğŸ§© Listing embedded resources:"
          find dist/WebTvMux.app -type f | grep -E "ffmpeg|ffprobe|yt-dlp|languages.json" || echo "âš ï¸ Some files missing"

      - name: ğŸ’½ Create DMG or fallback ZIP
        run: |
          echo "ğŸ“¦ Preparing release package..."
          cd dist
          if [ -f "WebTvMux.dmg" ]; then
            echo "âœ… DMG found: $(du -h WebTvMux.dmg)"
          else
            echo "âš ï¸ DMG not found, creating ZIP..."
            zip -r WebTvMux-macOS.zip WebTvMux.app
          fi
          cd ..

      - name: ğŸš€ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WebTvMux-macOS
          path: |
            dist/WebTvMux.dmg
            dist/WebTvMux-macOS.zip
