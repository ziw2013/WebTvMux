name: Build macOS App

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      APP_NAME: WebTvMux
      APP_VERSION: "1.0.0"

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------------------------------
      # üß© Dependency Setup
      # --------------------------------------------------
      - name: üß± Install build dependencies
        run: |
          echo "üîß Installing PyInstaller, PySide6, and UPX..."
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install pyinstaller==6.* pyside6==6.9.*
          brew install upx || echo "‚ö†Ô∏è UPX install skipped (already available)."
          echo "‚úÖ Environment ready."

      # --------------------------------------------------
      # üßπ Clean Build Environment
      # --------------------------------------------------
      - name: üßπ Clean previous builds
        run: |
          echo "üßπ Removing previous artifacts..."
          rm -rf build dist || true
          mkdir -p dist/release
          echo "‚úÖ Clean workspace ready."

      # --------------------------------------------------
      # üîç Verify Required Resources
      # --------------------------------------------------
      - name: üß© Verify bin/config folders
        run: |
          echo "üß© Checking local binaries and configs..."
          ls -lh bin || echo "‚ùå bin folder missing!"
          ls -lh config || echo "‚ùå config folder missing!"

      # --------------------------------------------------
      # üèóÔ∏è Build App
      # --------------------------------------------------
      - name: üèóÔ∏è Build macOS App (.app + DMG)
        run: |
          echo "üèóÔ∏è Starting macOS app build..."
          python -m PyInstaller build_macos.spec
          echo "‚úÖ Build complete."

      # --------------------------------------------------
      # üì¶ Package and Upload
      # --------------------------------------------------
      - name: üì¶ Package artifacts
        run: |
          echo "üì¶ Packaging version ${APP_VERSION}..."
          RELEASE_DIR="dist/release"
          APP_PATH="dist/${APP_NAME}.app"
          DMG_PATH="${RELEASE_DIR}/${APP_NAME}-macOS-v${APP_VERSION}.dmg"
          ZIP_PATH="${RELEASE_DIR}/${APP_NAME}-macOS-v${APP_VERSION}.zip"

          if [ ! -d "$APP_PATH" ]; then
            echo "‚ùå ERROR: ${APP_PATH} not found!"
            exit 1
          fi

          hdiutil create -volname "${APP_NAME}" \
            -srcfolder "${APP_PATH}" \
            -ov -format UDZO "${DMG_PATH}"

          cd dist
          zip -r "release/${APP_NAME}-macOS-v${APP_VERSION}.zip" "${APP_NAME}.app"
          cd ..

          echo "‚úÖ Packaging complete."
          du -sh ${DMG_PATH} ${ZIP_PATH}

      - name: ‚¨ÜÔ∏è Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WebTvMux-macOS-v${{ env.APP_VERSION }}
          path: |
            dist/release/WebTvMux-macOS-v${{ env.APP_VERSION }}.dmg
            dist/release/WebTvMux-macOS-v${{ env.APP_VERSION }}.zip
