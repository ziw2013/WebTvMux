name: Build macOS App

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      # --- Checkout repository ---
      - name: 🧭 Checkout repository
        uses: actions/checkout@v4

      # --- Set up Python ---
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- Install dependencies ---
      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==6.* pyside6==6.* upx

      # --- Verify binary and config folders before build ---
      - name: 🧩 Verify local bin/config presence
        run: |
          echo "🧩 Checking local binaries and configs..."
          ls -lh bin || echo "❌ bin folder missing!"
          ls -lh config || echo "❌ config folder missing!"

      # --- Run PyInstaller build ---
      - name: 🏗️ Build macOS App (.app + DMG)
        run: |
          echo "🏗️ Building macOS app bundle..."
          python -m PyInstaller build_macos.spec

      # --- Verify inclusion inside .app ---
      - name: 🔍 Verify .app contents
        run: |
          echo "🔍 Verifying inclusion of binaries and config..."
          if [ -d "dist/WebTvMux.app/Contents/MacOS/bin" ]; then
            echo "✅ bin folder found inside .app:"
            du -sh dist/WebTvMux.app/Contents/MacOS/bin/*
          else
            echo "❌ bin folder missing inside .app!"
            ls -R dist || true
          fi

          if [ -d "dist/WebTvMux.app/Contents/MacOS/config" ]; then
            echo "✅ config folder found inside .app:"
            ls -lh dist/WebTvMux.app/Contents/MacOS/config
          else
            echo "❌ config folder missing inside .app!"
          fi

      # --- Create DMG and ZIP ---
      - name: 📦 Package .app into DMG and ZIP
        run: |
          echo "📦 Creating DMG..."
          mkdir -p dist/release
          hdiutil create -volname WebTvMux \
            -srcfolder "dist/WebTvMux.app" \
            -ov -format UDZO "dist/release/WebTvMux.dmg"

          echo "📦 Creating ZIP..."
          cd dist
          zip -r release/WebTvMux.zip WebTvMux.app
          cd ..

          echo "✅ Packaging complete:"
          du -sh dist/release/*

      # --- Upload artifacts for download ---
      - name: ⬆️ Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WebTvMux-macOS
          path: |
            dist/release/WebTvMux.dmg
            dist/release/WebTvMux.zip
